image:
  name: grindwiseinc/propertymgmt.portfoliomgmt.house.register.pipeline:1.0  
  username: $DOCKER_HUB_USERNAME
  password: $DOCKER_HUB_PASSWORD
  email: $EMAIL
  ports: "27017:27017"

pipelines:
  default:
    - step:
        name: commit stage

        script:
          # build jar
          - gradle clean shadowJar

          # solitary tests
          - gradle solitaryTests

          # unit tests
          - gradle unitTests

          # checkstyle
          - gradle checkstyleMain

          # findbugs
          - gradle findbugsMain

        artifacts:
          # copy artifacts for following steps
          - build/libs/**

    - step:
          name: acceptance stage

          script:
            # start mongod
            - mongod --fork --logpath /var/log/mongod.log

            # acceptance tests
            - gradle acceptanceTests

    - step:
          name: create container image

          script:
            # docker - create image and push
            - gradle dockerCopy
            - cd docker/runtime_image
            - docker login --username $DOCKER_HUB_USERNAME --password $DOCKER_HUB_PASSWORD
            - docker build --force-rm --tag=grindwiseinc/propertymgmt.portfoliomgmt.house.register:$BITBUCKET_COMMIT .
            - docker push grindwiseinc/propertymgmt.portfoliomgmt.house.register:$BITBUCKET_COMMIT

    - step:
          name: deploy to rte

          deployment: test

          script:
            # deploy service
            - gradle deployService

options:
  docker: true

